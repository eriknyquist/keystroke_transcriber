keystroke_transcriber: records your keystrokes and writes an Arduino sketch to replay the same keystrokes
---------------------------------------------------------------------------------------------------------

If you need to write arduino sketches for USB HID keyboard emulation (Digispark, Teensy, Ducky USB), then
this module might be useful to you.

This module records global keystroke events on your PC (when you tell it to),
and uses the recorded keystroke sequence to write the sketch for you.

Simply tell it which programmable USB HID keyboard platform you're using, and start
pressing keys. keystroke_transcriber will generate a sketch file for you. You can
even choose to maintain the timing between your original keypresses, if you want.

Limitations
-----------

Currently only supports Digispark: Support for Ducky USB and Teensy devices will be coming soon

keystroke_transcriber command-line arguments
--------------------------------------------

::

    usage: keystroke_transcriber [-h] [-p {oneshot,repeat-forever,repeat-n}]
                                 [-t {digispark}] [-o OUTPUT_FILE]
                                 [-n REPEAT_COUNT] [-D REPEAT_DELAY_MS]
                                 [-d EVENT_DELAY_MS] [-m] [-r RECORD_SECONDS] [-s]

    Records global keypress events until Ctrl-C is pressed (or until a fixed time
    has elapsed), and translates them into a program that replays those keypress
    events on some programmable USB HID device (e.g. Digispark)

    optional arguments:
      -h, --help            show this help message and exit
      -p {oneshot,repeat-forever,repeat-n}, --playback-type {oneshot,repeat-forever,repeat-n}
                            Set the playback style for recorded keystroke
                            sequences (default: oneshot)
      -t {digispark}, --target-type {digispark}
                            Set the type of programmable USB HID device to
                            generate output for (default: digispark)
      -o OUTPUT_FILE, --output-file OUTPUT_FILE
                            Write output to this file, instead of printing output
                            to the terminal (default: None)
      -n REPEAT_COUNT, --repeat-count REPEAT_COUNT
                            Sets how many times the recorded keystroke sequence
                            should be repeated (only used if playback_type is
                            repeat-n) (default: 1)
      -D REPEAT_DELAY_MS, --repeat-delay-ms REPEAT_DELAY_MS
                            Sets delay between recorded keystroke sequence
                            repetitions, in milliseconds (only used if
                            playback_type is repeat-n or repeat-forever) (default:
                            0)
      -d EVENT_DELAY_MS, --event-delay-ms EVENT_DELAY_MS
                            Sets delay between individual keystroke events, in
                            milliseconds (only used if maintain_timing is False)
                            (default: 0)
      -m, --maintain-timing
                            Maintain timing between recorded keystrokes (default:
                            False)
      -r RECORD_SECONDS, --record-seconds RECORD_SECONDS
                            Record for this many seconds, instead of recording
                            until Ctrl-C is seen (default: None)
      -s, --translate-scan-codes
                            Attempt to translate PS/2 scan codes to USB HID usage
                            ID codes (default: True)


Example Digispark sketch generated by keystroke_transcriber
-----------------------------------------------------------

For this example, I ran keystroke_transcriber with the following arguments to record
keypress events until Ctrl+C, and generate a sketch for Digispark devices:

::

    python -m keystroke_transcriber -p oneshot -t digispark -m

Then, I performed the following keypresses:

#. Typed Ctrl+R (to open the "run" program)
#. Typed "notepad", followed by the Enter key (to open the Notepad application)
#. Typed "Hello, from keystroke_transcriber!!!!"
#. Typed Ctrl+C to stop the recording

After I pressed Ctrl+C, keystroke_transcriber provided the following Digispark sketch:

::

    // Auto-generated by keystroke_transcriber. Do not modify!

    #include "DigiKeyboard.h"

    #define NUM_EVENTS (91u)

    struct key_event
    {
        uint8_t key;
        uint8_t mods;
        uint32_t delay_before_ms;
    };

    const struct key_event key_events[NUM_EVENTS] PROGMEM =
    {
        {0, MOD_GUI_LEFT, 0u}, {21u, MOD_GUI_LEFT, 122u}, {0, MOD_GUI_LEFT, 84u},
        {0, 0, 30u}, {17u, 0, 269u}, {18u, 0, 48u}, {0, 0, 87u}, {23u, 0, 46u},
        {8u, 0, 60u}, {0, 0, 58u}, {19u, 0, 70u}, {0, 0, 71u}, {4u, 0, 27u},
        {7u, 0, 55u}, {0, 0, 68u}, {40u, 0, 292u}, {0, 0, 59u},
        {0, MOD_SHIFT_LEFT, 847u}, {11u, MOD_SHIFT_LEFT, 199u}, {0, 0, 45u},
        {8u, 0, 77u}, {0, 0, 56u}, {15u, 0, 86u}, {0, 0, 40u}, {15u, 0, 88u},
        {18u, 0, 59u}, {0, 0, 84u}, {54u, 0, 72u}, {44u, 0, 73u}, {0, 0, 85u},
        {9u, 0, 15u}, {0, 0, 54u}, {21u, 0, 85u}, {18u, 0, 34u}, {16u, 0, 59u},
        {0, 0, 69u}, {44u, 0, 130u}, {0, 0, 80u}, {14u, 0, 336u}, {0, 0, 57u},
        {8u, 0, 37u}, {0, 0, 41u}, {28u, 0, 52u}, {0, 0, 52u}, {22u, 0, 24u},
        {0, 0, 35u}, {23u, 0, 118u}, {21u, 0, 44u}, {0, 0, 58u}, {18u, 0, 5u},
        {14u, 0, 58u}, {0, 0, 65u}, {8u, 0, 22u}, {0, 0, 41u},
        {0, MOD_SHIFT_LEFT, 108u}, {45u, MOD_SHIFT_LEFT, 55u},
        {0, MOD_SHIFT_LEFT, 39u}, {0, 0, 29u}, {23u, 0, 178u}, {21u, 0, 37u},
        {0, 0, 52u}, {4u, 0, 5u}, {0, 0, 61u}, {17u, 0, 92u}, {22u, 0, 49u},
        {0, 0, 41u}, {6u, 0, 108u}, {0, 0, 46u}, {21u, 0, 108u}, {0, 0, 29u},
        {12u, 0, 11u}, {5u, 0, 76u}, {0, 0, 70u}, {8u, 0, 35u}, {21u, 0, 61u},
        {0, 0, 31u}, {0, MOD_SHIFT_LEFT, 798u}, {30u, MOD_SHIFT_LEFT, 160u},
        {0, MOD_SHIFT_LEFT, 42u}, {30u, MOD_SHIFT_LEFT, 126u},
        {0, MOD_SHIFT_LEFT, 8u}, {30u, MOD_SHIFT_LEFT, 98u},
        {0, MOD_SHIFT_LEFT, 25u}, {30u, MOD_SHIFT_LEFT, 84u},
        {0, MOD_SHIFT_LEFT, 31u}, {0, 0, 111u}, {0, MOD_CONTROL_LEFT, 589u},
        {0, MOD_CONTROL_LEFT, 505u}, {0, MOD_CONTROL_LEFT, 30u},
        {0, MOD_CONTROL_LEFT, 31u}, {0, 0, 12u}
    };

    void send_key_event(const struct key_event *event)
    {
        if (0u < event->delay_before_ms)
        {
            DigiKeyboard.delay(event->delay_before_ms);
        }

        DigiKeyboard.sendKeyPress(event->key, event->mods);
    }

    // Read a single key event from PROGMEM, by array index
    void read_key_event_by_index(int index, struct key_event *event)
    {
        event->key = pgm_read_byte_near(&key_events[index].key);
        event->mods = pgm_read_byte_near(&key_events[index].mods);
        event->delay_before_ms = pgm_read_dword_near(&key_events[index].delay_before_ms);
    }

    void replay_key_events()
    {
        for (unsigned i = 0u; i < NUM_EVENTS; i++)
        {
            struct key_event event;
            read_key_event_by_index(i, &event);
            send_key_event(&event);
        }
    }

    void setup()
    {
        replay_key_events();
    }

    void loop()
    {

        DigiKeyboard.update();
    }

If you flash this sketch on to your Digispark, and plug the Digispark into a Windows
PC, you will see the keyboard activity I just described, complete with the timing of my original keypresses.
